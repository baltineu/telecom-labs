![Топология](https://github.com/baltineu/telecom-labs/blob/main/cisco_pt/ccna_openedu/sources/topology3.PNG)

# Цели:

1) Изучить теорию, принципы работы протокола связующего дерева;
2) Изучить процесс конфигурирования Per VLAN RSTP;
3) Собрать и настроить топологию, показанную на рисунке, с использованием Per VLAN RSTP.

На примере одной из петель объяснить, как строится дерево для каждого VLAN.

Рассмотреть возможные изменения дерева при изменении port cost (напрямую и при изменении speed).
# STP 

STP необходим для резервации линков. Без STP есть три проблемы, с которыми мы сталкиваемся, если создаём «треугольник» или ещё какой-то граф с циклами из свитчей:

1) Широковещательный шторм (свитчи будут переотправлять друг другу и множить широковещалки)
2) Множественные копии пакетов (один и тот же пакет пойдёт по двум и более путям (если mac – широковещалка) и придёт несколько раз)
3) Нестабильность таблицы коммутации (пришедший на два интерфейса от одного и того же мака пакет вынудит свитч изменить таблицу коммутации).

STP решает эти проблемы построением дерева и отключением (резервацией) некоторых маршрутов.

STP – spanning-tree protocol – протокол связующего дерева.

Построение дерева начинается с выбора корня. Корневым (root bridge – корневой мост) становится свитч с наименьшим значением приоритета (по умолчанию 32768). Если у всех свитчей одинаковый приоритет, выбирается свитч с наименьшим мак-адресом. 

На каждом не-корневом свитче выбирается корневой порт (root port) (порт, предоставляющий минимальную стоимость пути от свитча, которому принадлежит порт, до корневого свитча – учитывается и скорость линков, и количество хопов). 

Ещё выбираются назначенные порты (designated port) – один на сегмент. Этот порт предоставляет минимальную стоимость пути до RB от сегмента (в простейшем случае все сегменты у нас point-to-point). 

В конце, если у нас остаётся один сегмент, один из портов будет назначенным, а другой заблокированным. Назначенным станет порт свитча с меньшим приоритетом, либо, если приоритеты равны, с наименьшим маком. 

Краткий алгоритм:

1) Выбор корневого моста
1) Выбор корневых портов
1) Выбор назначенных портов
1) Блокировка оставшихся портов. 

Для обычного STP порт проходит 4 состояния: (50 секунд)

1) Сначала все порты в Blocking, который длится 20 секунд
1) Listening – пересылаются только служебные данные, 15 секунд
1) Learning – 15 секунд
1) Forwarding – передача
# Rapid STP

Просто заменили Blocking + Listening = Discarding (отбрасывание), которое теперь в сумме длится 15 секунд. (30 секунд всё вместе). 

Изменились и типы портов: portfast – на нём не может возникнуть петля (подключен к конечному устройству), поэтому он не участвует в построении дерева, пропускает learning в RSTP и listening+learning в STP, сразу переходя в forwarding и становясь designated-портом (с. 235); backup port – дублер назначенного порта (с.233), alternate port – дублер корневого порта (с. 230).

Порт становится дублером назначенного порта, если располагается в том же сегменте (домене коллизий), что и назначенный порт. Такое возможно в случае резервирования, который редко применяется на практике:

![1](https://github.com/baltineu/telecom-labs/blob/main/cisco_pt/ccna_openedu/sources/lab3/1.png)

В этом случае очевидно, что порты предоставляют одинаковую стоимость пути из данного сегмента до корневого коммутатора. BID так же одинаков, поскольку порты относятся к одному коммутатору. Выбор назначенного между ними происходит по приоритету порта (который по умолчанию равен номеру). Если приоритет одинаков, выбор происходит по номеру порта. Если f0/1 отключится, f0/2 займет его место в роли назначенного порта.

Дублер корневого порта рассмотрен на примере в разделе Практика. 
# Per VLAN RSTP

С. 218 – Bridge ID и Hello BPDU

BID состоит из 2 байт приоритета и 6 байт system ID (используется MAC-адрес).

BPDU – bridge prot. data units содержит информацию:

1) О том, кого отправитель считает корневым свитчом
2) Какой у отправителя BID
3) Какова цена пути до корня от отправителя
4) Таймеры


|Поле|Описание|
| :- | :- |
|<p>Root bridge ID</p><p>ID корневого коммутатора</p>|В этом поле указывается Bridge ID того коммутатора, которого коммутатор-отправитель считает корневым|
|<p>Sender’s bridge ID</p><p>ID коммутатора-отправителя</p>|Bridge ID коммутатора-отправителя этого Hello BPDU|
|<p>Sender’s root cost</p><p>Стоимость пути до корневого коммутатора от отправителя</p>|Стоимость пути (STP/RSTP) от коммутатора-отправителя до корневого коммутатора|
|<p>Timer values on the root switch</p><p>Значения таймеров на корневом коммутаторе</p>|Включает в себя значение таймера приветственной рассылки (Hello), таймера срока давности (MaxAge), задержки пересылки (forward delay)|

## Выбор корневого моста (c.219)
Построение дерева начинается с выбора корня. Корневым (root bridge – корневой мост) становится свитч с наименьшим значением приоритета (по умолчанию 32768). Если у всех свитчей одинаковый приоритет, выбирается свитч с наименьшим мак-адресом. (Приоритет и System ID входят в один BID, передающийся по BPDU)

Процесс выбора происходит при помощи передачи Hello BPDU. Сначала все мосты отправляют BPDU со своим BID в качестве Root bridge ID. Затем, если они получили BPDU с меньшим, чем у них, root BID, они начинают рассылать BPDU именно с этим root BID. 

В итоге остаётся один root bridge.
## Выбор корневых портов (c.220)
На каждом не-корневом свитче выбирается корневой порт (root port) (порт, предоставляющий минимальную стоимость пути от свитча, которому принадлежит порт, до корневого свитча – учитывается и скорость линков, и количество хопов – least root cost). 

В каждом BPDU свитч, его отправивший, указывает root cost – стоимость пути до корневого моста. Root cost – это и стоимость root port, так как путь до RB пролегает именно через него. 

![2](https://github.com/baltineu/telecom-labs/blob/main/cisco_pt/ccna_openedu/sources/lab3/2.png)

Нужно сложить стоимости портов, из которых должен *выйти* кадр, проходя путь. В качестве root port выбирается порт, из которого путь меньше по стоимости. 

Коммутаторы узнают стоимости из сообщений и выбирают свой root port.

Port cost – целое число, привязанное к конкретному интерфейсу для конкретного vlan.

![3](https://github.com/baltineu/telecom-labs/blob/main/cisco_pt/ccna_openedu/sources/lab3/3.png)

1) Корневой коммутатор отправляет Hello-сообщения с root cost = 0
2) Sw2, Sw3 добавляют этот 0 к своим port costs
3) Sw2 отправляют Sw3 Hello с root cost = 4
4) Sw3 добавляет 4 к Gi0/2 port cost
5) Sw3 выбирает Gi0/1 корневым портом.

Если где-то получаются равные стоимости, то:

1) Выбирается порт с наименьшим Bridge ID соседа;
2) Выбирается порт с наименьшим приоритетом порта соседа;
3) Выбирается порт с наименьшим внутренним номером порта соседа (в случае когда два порта одного коммутатора с одинаковым приоритетом включены в один домен коллизий через хаб)

## Выбор назначенных портов (c.222)
Designated портом в каждом сегменте (домене коллизий) становится порт того свитча, у которого минимальная root cost. Если root cost совпадают, выбирается порт свитча с минимальным BID. Если и они совпадают, выбирается порт с наименьшим приоритетом. Если и приоритеты совпадают, выбирается порт с наименьшим номером.

Все DP переходят в forwarding state.
## Остальные порты блокируются (c.223)
Порты, ведущие до конечных устройств становятся designated, поскольку конечные устройства не говорят свой root cost и не дают портам свитча стать root; зато порты свитча выигрывают в designated по той же причине.

В RSTP порты не блокируются, а резервируются в двух вариантах, как описано выше.
## Настройка топологии STP (c.223)
Можно влиять на приоритет (BID) устройства и на port costs.

|Скорость Ethernet|IEEE cost: 1998 и раньше|IEEE cost: 2004 и позднее|
| :- | :- | :- |
|10 Мбит/с|100|2 000 000|
|100 Мбит/с|19|200 000|
|1 Гбит/с|4|20 000|
|10 Гбит/c |2|2000|
|100 Гбит/c|N/A|200|
|1 Тб/c|N/A|20|

Важно: на cost влияет не макс. скорость, а действующая (минимальная скорость из портов в сегменте).

Важно: можно использовать значения из более поздних стандартов:

```
spanning-tree pathcost method long
```

# Повлиять на построение дерева (с.247)
Изменить корень можно изменив приоритет коммутатора командой:

```
spanning-tree vlan x priority y
```

Можно заставить коммутатор самостоятельно определить такой приоритет, чтобы стать первичным/вторичным корнем. Вторичный корень – корень, который заменит первичный в случае отключения. Команда:

```
spanning-tree vlan x root primary | secondary
```

Можно изменить port cost для конкретного или для всех VLAN командой:

```
spanning-tree [vlan x] cost y
```

# Практика

1) Назначить IP-адреса компьютерам;
1) Настроить access-порты на соответствующие VLAN;
1) Настроить интерфейсы и подинтерфейсы роутера: включить dot1q, назначить IP-адреса;
1) Прописать адреса шлюзов (gateway) на компьютерах;
1) Настроить trunk-порты;
1) Включить Rapid-PVST на коммутаторах: spanning-tree mode rapid-pvst;
1) Включить portfast на портах, подключенных к конечным устройствам (int fa 0/xx; spanning-tree portfast). 

Анализ полученного состояния левой петли в топологии:

1) Корневой коммутатор

Из вывода команды:
```
show spanning-tree
```
на каждом из коммутаторов получены следующие значения Bridge ID (Priority + MAC) и port costs:

![4](https://github.com/baltineu/telecom-labs/blob/main/cisco_pt/ccna_openedu/sources/lab3/4.png)

Так как приоритеты у всех коммутаторов одинаковые, выбор корневого коммутатора происходит по MAC-адресам. Коммутатор с наименьшим MAC становится корневым. В данном случае корневым становится Switch0 (верхний).

2) Корневые порты

У всех интерфейсов будет скорость 100 Мбит/с, что соответствует 19. Во всех VLAN корневыми будут выбраны: fa0/22 Switch1 (root cost = 19), fa0/22 Switch2 (root cost = 19), fa0/24 Switch3 (root cost = 38). 

3) Назначенные порты

Назначенным портом в каждом сегменте (домене коллизий) становится порт коммутатора с меньшей root cost. Назначенными точно будут: fa0/22, fa0/23 Switch0 (root cost = 0), fa0/24 Switch2 (root cost = 19). У Switch1 и Switch2 root cost одинакова и составляет 19. Выбор между портами fa0/23 Switch1 и fa0/23 Switch2 осуществляется по Bridge ID. MAC меньше у Switch1, поэтому его порт и станет назначенным.

4) Alternate порт (зарезервированный корневой порт)

Оставшийся fa0/23 Switch2 будет являться зарезервированным корневым портом (RSTP), поскольку именно он в случае отключения корневого порта fa0/22 будет предоставлять наименьшую стоимость пути до корневого коммутатора (с. 230).

Если изменить port cost на интерфейсе fa0/22 Switch2 для VLAN 2 на 39:

```
interface fa0/22
spanning-tree vlan 2 cost 39
```

То для VLAN 2 alternate-портом станет fa0/22 со стоимостью 39, в то время как fa0/23 будет предоставлять root cost = 38. Таким образом можно балансировать нагрузку: пакеты vlan1 будут проходить по одному пути, а vlan2 по другому.

Аналогично перестройки дерева для всех VLAN можно добиться, изменив (снизив) скорость порта.

```
interface fa0/xx
speed 10
```

Если меняется (опускается) значение скорости до 10 Мбит/с, port cost становится равной 100.



